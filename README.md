# Решение тестового задания: Web API для игры в Крестики Нолики

Решение тестового задания на стажировку backend разработчик Банка C#/PostgreSQL. Спроектированно и реализованно REST API для игры в крестики нолики с помощью .NET 9 и дополнительных библиотек, в качестве СУБД выбрана PostgreSQL. Были выполнены все указанные требования.

---

## Архитектурные решения

*  **Чистая  архитектура (Onion Architecture)** - для разделения системы на части для обеспечения гибкости и масштабируемости.
*  **SQRS** - разделяет операции на команды и запросы, используется библиотека MediatR.
*  **Переменные окружения** - для задания размера поля, условия победы, строки подключения.
*  **Контейнеризация с Docker и Docker Compose** - для простого развертывания и запуска всего стека одной командой
*  **Persistence crash-safe** - после перезапуска контейнеров сессия игрока сохраняется.
*  **Идемпотентность** для `POST /moves` запросов на совершение хода. Для этого 
*  **Unit-тесты** (xUnit) - имеются юнит тесты для проверки частей системы, а также интеграционные тесты для проверки системы целиком.
*  **Запуск тестов в CI** - настроен файл GitHub Actions для проверки сборки и запуска тестов. 

---

## Структура проекта (Onion Architecture)

1.  **`TickiTackToe.Domain`**
    *   **Домен приложения.** Содержит главную сущность игры `Game`, содержащую логику предметной области (в том числе задается 10% шанса на неудачный третий ход), также содержит перечисления.

2.  **`TickiTackToe.Application`**
    *   **Слой бизнес-логики приложения.** Содержит use cases, реализованные с помощью команд и запросов MediatoR (SQRS). Содержит интерфейсы для внешних зависимостей, с которыми в DI контейнере выбирается реализация. Зависимость от `Domain`.

3.  **`TickiTackToe.Infrastructure`**
    *   **Слой инфраструктуры.** Содержит реализацию интерфейсов из слоя Application, а также класс `TickDbContext` для взаимодействия с БД PostgreSQL через EF Core, и миграции. Зависит от `Domain`, `Application`.

4.  **`TickiTackToe.Api`**
    *   **Слой представления.** Точка входа в приложение. Представляет собой ASP.NET Core Web API с контроллерами, которые принимают запросы, далее в командах/запросах MediatR идет обработка запросов и возвращаются ответы. Содержит собственный middleware для обеспечения идемпотентности, файл конфигурации API и DI контейнера. Зависит от `Application` и `Infrastructure`.

---

### Запуск проект

Для запуска проекта необходимы Docker и Docker Compose (в Windows Docker Desktop)

1. Склонируйте проект с GitHub:
```bash
git clone https://github.com/turbo821/internship-entry-task.git
```
3. Перейдите в корень приложения:
```bash
cd ./TickiTackToe
```
5. Запустите в Docker Compose:
```bash
docker-compose up
```
После этого соберутся два контейнера с БД PostgreSQL и с API. При успешном запуске API будет доступно по адресу: `http://localhost:8080`

#### Запуск тестов:

1. В Visual Studio
2. Перейдите в корень приложения и запустить тесты командой:
```bash
cd ./TickiTackToe
dotnet test
```

---

## Описание API

Интерактивная документация Swagger доступна по адресу `http://localhost:8080/swagger/index.html` после запуска приложения.

### Описание endpoints

#### 1. Проверка работоспособности
*   **Endpoint:** `GET /health`
*   **Описание:** Для проверки доступности сервиса.
*   **Тело запроса:** Пустое.
*   **Успешный ответ:** `200 OK`.

#### 2. Создание новой игры
*   **Endpoint:** `POST /games`
*   **Описание:** Создает новую игру с параметрами (размер поля, условие победы), взятыми из конфигурации на сервере.
*   **Тело запроса:** Пустое.
*   **Успешный ответ:** `200 OK`
 ```json
   {
     "id": "dc9d8527-411f-4d85-945d-afe7030a46d3",
     "gameSize": 3,
     "winCondition": 3,
     "status": "InProgress",
     "moveNumber": 1,
     "currentPlayer": "X",
     "field": [
       [
         "",
         "",
         ""
       ],
       [
         "",
         "",
         ""
       ],
       [
         "",
         "",
         ""
       ]
     ]
   }
 ```

#### 3. Получение состояния игры
*   **Endpoint:** `GET /games/{id}`
*   **Описание:** Возвращает текущее состояние игры по ее id.
*   **Успешный ответ:** `200 OK`
 ```json
   {
     "id": "f09dff50-f7f2-41e2-87ed-bbaf86957eb7",
     "gameSize": 3,
     "winCondition": 3,
     "status": "InProgress",
     "moveNumber": 3,
     "currentPlayer": "X",
     "field": [
       [
         "X",
         "",
         ""
       ],
       [
         "",
         "O",
         ""
       ],
       [
         "",
         "",
         ""
       ]
     ]
   }
 ```
*   **Ошибки:** `404 Not Found`: Игра не найдена

#### 4. Совершение хода
*   **Endpoint:** `POST /games/{id}/moves`
*   **Описание:** Выполняет ход игрока. Запрос должен быть идемпотентным.
*   **Заголовки:**
    *   `Idempotency-Key` (необязательный): Уникальный ключ для каждого запроса на ход.
*   **Тело запроса:**
 ```json
   {
     "player": "O",
     "row": 1,
     "column": 2
   }
 ```
*   **Успешный ответ:** `200 OK`
    *   Тело ответа содержит обновленное состояние игры.
*   **Ошибки:**
    *   `400 Bad Request`: Некорректный JSON, ход вне поля, клетка занята, игра закончена, не тот игрок.
    *   `404 Not Found`: Игра не найдена.
 
---
